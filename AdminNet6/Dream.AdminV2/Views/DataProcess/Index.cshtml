<title>导入</title>
<link href="~/Content/assets/css/dropzone.min.css" rel="stylesheet" />
<!-- ajax layout which only needs content area -->
<div class="page-header">
    <h1>
        返利数据处理
        <small>
            <i class="ace-icon fa fa-angle-double-right"></i>
            在这里您可以处理返利数据
        </small>
    </h1>
</div><!-- /.page-header -->

<div class="row">
    <div class="col-xs-12">
        <!-- PAGE CONTENT BEGINS -->
        <div class="row">
            <div class="form-group">
                <div class="col-sm-12">
                    <div>
                        <div action="#" class="dropzone well" id="dropzone">
                            <div class="fallback">
                                <input name="file" type="file" />
                            </div>
                        </div>
                    </div>

                    <div id="preview-template" class="hide">
                        <div class="dz-preview dz-file-preview">
                            <div class="dz-image">
                                <img data-dz-thumbnail="" />
                            </div>

                            <div class="dz-details">
                                <div class="dz-size">
                                    <span data-dz-size=""></span>
                                </div>

                                <div class="dz-filename">
                                    <span data-dz-name=""></span>
                                </div>
                            </div>

                            <div class="dz-progress">
                                <span class="dz-upload" data-dz-uploadprogress=""></span>
                            </div>

                            <div class="dz-error-message">
                                <span data-dz-errormessage=""></span>
                            </div>

                            <div class="dz-success-mark">
                                <span class="fa-stack fa-lg bigger-150">
                                    <i class="fa fa-circle fa-stack-2x white"></i>

                                    <i class="fa fa-check fa-stack-1x fa-inverse green"></i>
                                </span>
                            </div>

                            <div class="dz-error-mark">
                                <span class="fa-stack fa-lg bigger-150">
                                    <i class="fa fa-circle fa-stack-2x white"></i>

                                    <i class="fa fa-remove fa-stack-1x fa-inverse red"></i>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="clearfix form-actions">
                        <div class="col-md-offset-5 col-md-9">
                            <span class="btn btn-info bigger-225" id="btnPublish" type="button">
                                <i class="ace-icon fa fa-check bigger-110"></i>
                                开始处理
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-10"></div>
        </div>
        <!-- PAGE CONTENT ENDS -->
    </div><!-- /.col -->
</div><!-- /.row -->
<!--不要改变脚本加载顺序,否则会导致表格初始化失败,原因待查-->
<script src="/Content/assets/js/date-time/moment.min.js"></script>
<!-- page specific plugin scripts -->
<script type="text/javascript">
    var scripts = [null,
        "/Content/assets/js/dropzone.min.js",
        null]
    ace.load_ajax_scripts(scripts, function () {
        //inline scripts related to this page
        ace.load_ajax_scripts([null, null, null], function () {
            jQuery(function ($) {
                try {

                    Dropzone.autoDiscover = false;
                    var myDropzone = new Dropzone('#dropzone', {
                        previewTemplate: $('#preview-template').html(),
                        acceptedFiles: ".xlsx,.xls,.csv",
                        uploadMultiple: false,
                        addRemoveLinks: true,
                        maxFiles: 1,
                        dictRemoveFile: '移除',
                        dictDefaultMessage:
                        '<span class="bigger-150 bolder"><i class="ace-icon fa fa-caret-right red"></i> Drop files</span> to upload \
				<span class="smaller-80 grey">(or click)</span> <br /> \
				<i class="upload-icon ace-icon fa fa-cloud-upload blue fa-3x"></i>'
                        ,

                        thumbnail: function (file, dataUrl) {
                            if (file.previewElement) {
                                $(file.previewElement).removeClass("dz-file-preview");
                                var images = $(file.previewElement).find("[data-dz-thumbnail]").each(function () {
                                    var thumbnailElement = this;
                                    thumbnailElement.alt = file.name;
                                    thumbnailElement.src = dataUrl;
                                });
                                setTimeout(function () { $(file.previewElement).addClass("dz-image-preview"); }, 1);
                            }
                        },
                        init: function () {
                            this.on("addedfile", function (file) {
                                // actions...
                            });
                            this.on("removedfile", function (file) {
                                // actions...

                            });
                        }

                    });

                    //simulating upload progress
                    var minSteps = 6,
                        maxSteps = 60,
                        timeBetweenSteps = 100,
                        bytesPerStep = 100000;

                    myDropzone.uploadFiles = function (files) {
                        var self = this;

                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                            totalSteps = Math.round(Math.min(maxSteps, Math.max(minSteps, file.size / bytesPerStep)));

                            for (var step = 0; step < totalSteps; step++) {
                                var duration = timeBetweenSteps * (step + 1);
                                setTimeout(function (file, totalSteps, step) {
                                    return function () {
                                        file.upload = {
                                            progress: 100 * (step + 1) / totalSteps,
                                            total: file.size,
                                            bytesSent: (step + 1) * file.size / totalSteps
                                        };

                                        self.emit('uploadprogress', file, file.upload.progress, file.upload.bytesSent);
                                        if (file.upload.progress == 100) {
                                            file.status = Dropzone.SUCCESS;
                                            self.emit("success", file, 'success', null);
                                            self.emit("complete", file);
                                            self.processQueue();
                                            $(".dz-progress").hide();
                                        }
                                    };
                                }(file, totalSteps, step), duration);
                            }
                        }
                    }
                    $("#btnPublish").on("click", function () {

                        WaitDialog.show();
                        var fd = new FormData();
                        $.each(myDropzone.files, function (i, file) {
                            fd.append('files', file);
                        });
                        var deffer= $.ajax({
                            url: config.dataProcessUrl,
                            type: 'POST',
                            contentType: false,
                            data: fd,
                            cache: false,
                            processData: false
                        });
                        deffer.done(function () {
                            WaitDialog.hide()
                            alert("处理完毕");
                        });
                    });
                    //remove dropzone instance when leaving this page in ajax mode
                    $(document).one('ajaxloadstart.page', function (e) {
                        try {
                            myDropzone.destroy();
                        } catch (e) { }
                    });

                } catch (e) {
                    alert('Dropzone.js does not support older browsers!');
                }
            });
        });
    });
</script>

